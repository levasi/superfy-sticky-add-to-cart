{% comment %}
  Sticky Add to Cart Bar Block
  Add this block to your product page template.
  Uses app proxy to fetch dynamic settings from the backend.
{% endcomment %}

{% if template contains 'product' and product %}
  {% assign current_product = product %}
  {% assign current_variant = product.selected_or_first_available_variant %}

  <div class="sfy-sb sticky-add-to-cart-block"
       data-product-id="{{ current_product.id }}"
       data-variant-id="{{ current_variant.id }}"
       style="display: none;">
    <div class="sfy-sb-container">
      <div class="sfy-sb-content">
        <div class="sfy-sb-image --sfy-medium">
          <img src="{{ current_product.featured_image | img_url: '60x60', crop: 'center' }}" 
               alt="{{ current_product.title }}" />
        </div>
        <div class="sfy-sb-details">
          <div class="sfy-sb-name">
            <h2>{{ current_product.title }}</h2>
          </div>
          <div class="sfy-sb-price">
            {% if current_variant.compare_at_price > current_variant.price %}
              <span class="price-compare" style="text-decoration: line-through; margin-right: 8px;">{{ current_variant.compare_at_price | money }}</span>
            {% endif %}
            <span class="price">{{ current_variant.price | money }}</span>
          </div>
        </div>
      </div>
      <div class="sfy-sb-actions">
        <div class="sfy-sb-qty">
          <button
            class="sfy-sb-qty-button"
            type="button"
            name="minus"
            data-action="decrease"
          >
            <svg
              class="sfy-svg"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path d="M4 12H20" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
          <input
            type="number"
            name="sfy-quantity"
            value="1"
            min="1"
            step="1"
          />
          <button
            class="sfy-sb-qty-button"
            type="button"
            name="plus"
            data-action="increase"
          >
            <svg
              class="sfy-svg"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path d="M12 4V20" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
        </div>
        <button class="sfy-sb-add-to-cart-button" type="button">
          <span class="sfy-sb-add-to-cart-text">
            <span class="sfy-sb-add-to-cart-icon sfy-svg">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18 14.25C18.4142 14.25 18.75 14.5858 18.75 15V17.25H21C21.4142 17.25 21.75 17.5858 21.75 18C21.75 18.4142 21.4142 18.75 21 18.75H18.75V21C18.75 21.4142 18.4142 21.75 18 21.75C17.5858 21.75 17.25 21.4142 17.25 21V18.75H15C14.5858 18.75 14.25 18.4142 14.25 18C14.25 17.5858 14.5858 17.25 15 17.25H17.25V15C17.25 14.5858 17.5858 14.25 18 14.25ZM12 3.25C14.3681 3.25 16.3308 4.98306 16.6904 7.25H17C19.0711 7.25 20.75 8.92893 20.75 11V12C20.75 12.4142 20.4142 12.75 20 12.75C19.5858 12.75 19.25 12.4142 19.25 12V11C19.25 9.75736 18.2426 8.75 17 8.75H7C5.75736 8.75 4.75 9.75736 4.75 11V17C4.75 18.2426 5.75736 19.25 7 19.25H12C12.4142 19.25 12.75 19.5858 12.75 20C12.75 20.4142 12.4142 20.75 12 20.75H7C4.92893 20.75 3.25 19.0711 3.25 17V11C3.25 8.92893 4.92893 7.25 7 7.25H7.30957C7.6692 4.98306 9.63189 3.25 12 3.25ZM12 4.75C10.4633 4.75 9.17655 5.81675 8.83789 7.25H15.1621C14.8235 5.81675 13.5367 4.75 12 4.75Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            <span class="sfy-sb-add-to-cart-text__content">Add to cart</span>
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Load settings from app proxy -->
  <link rel="stylesheet" href="{{ 'sticky-bar.css' | asset_url }}?v={{ 'now' | date: '%s' }}">
  <script src="{{ 'sticky-settings.js' | asset_url }}?v={{ 'now' | date: '%s' }}" defer></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const productId = {{ current_product.id }};
      const variantId = {{ current_variant.id }};
      const block = document.querySelector('.sticky-add-to-cart-block');
      
      if (!block) {
        console.error('Sticky bar block not found!');
        return;
      }

      // Wait for settings to load from app proxy
      window.StickyBarSettings.onLoad(function(settings) {
        
        // Apply settings (this will handle visibility via CSS classes)
        window.StickyBarSettings.applySettings();
        
        // Set up quantity selector
        const quantityInput = block.querySelector('.sfy-sb-qty input');
        const decreaseBtn = block.querySelector('[data-action="decrease"]');
        const increaseBtn = block.querySelector('[data-action="increase"]');
        
        if (decreaseBtn && increaseBtn && quantityInput) {
          decreaseBtn.addEventListener('click', () => {
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
              quantityInput.value = currentValue - 1;
            }
          });
          
          increaseBtn.addEventListener('click', () => {
            const currentValue = parseInt(quantityInput.value);
            if (currentValue < 99) {
              quantityInput.value = currentValue + 1;
            }
          });
        }
        
        // Set up add to cart functionality
        const addToCartBtn = block.querySelector('.sfy-sb-add-to-cart-button');
        if (addToCartBtn) {
          addToCartBtn.addEventListener('click', function() {
            const quantity = parseInt(quantityInput?.value || 1);
            
            fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: variantId,
                quantity: quantity
              })
            })
            .then(res => res.json())
            .then(data => {
              
              // Try to open the offcanvas cart if the theme supports it
              if (window.Shopify && window.Shopify.theme && window.Shopify.theme.cart && window.Shopify.theme.cart.open) {
                window.Shopify.theme.cart.open();
              }
              
              // Or trigger a custom event for other themes
              document.dispatchEvent(new CustomEvent('cart:updated', { detail: data }));
              
              // Show success message
              const buttonText = addToCartBtn.querySelector('.sfy-sb-add-to-cart-text__content');
              if (buttonText) {
                const originalText = buttonText.textContent;
                buttonText.textContent = 'Added!';
                setTimeout(() => {
                  buttonText.textContent = settings.sticky_button_text || 'Add to cart';
                }, 2000);
              }
            })
            .catch(err => {
              console.error('Could not add to cart:', err);
              alert('Could not add to cart!');
            });
          });
        }
      });
    });
  </script>

  <style>
    .sfy-sb {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      background: #fff;
      border-top: 1px solid #ddd;
      padding: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      width: 100%;
    }
    
    .sfy-sb-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      width: 100%;
      margin: 0 auto;
    }
    
    .sfy-sb-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .sfy-sb-image {
      flex-shrink: 0;
    }
    
    .sfy-sb-image.--sfy-medium img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e1e3e5;
    }
    
    .sfy-sb-details {
      flex: 1;
      min-width: 0;
    }
    
    .sfy-sb-name h2 {
      font-weight: 600;
      font-size: 14px;
      margin: 0 0 2px 0;
      white-space: wrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #141414;
    }
    
    .sfy-sb-price .price {
      font-size: 13px;
      font-weight: 600;
      color: #141414;
    }
    
    .sfy-sb-price .price-compare {
      text-decoration: line-through;
      color: #6d7175;
      margin-right: 8px;
    }
    
    .sfy-sb-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    
    .sfy-sb-qty {
      display: flex;
      align-items: center;
      border: 1px solid #DFDFDF;
      border-radius: 20px;
      overflow: hidden;
      background: #fff;
      height: 36px;
      min-width: 120px;
    }
    
    .sfy-sb-qty-button {
      border: none;
      background: transparent;
      padding: 0 16px;
      cursor: pointer;
      color: #6d7175;
      font-size: 16px;
      font-weight: 600;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      transition: background-color 0.2s;
    }
    
    .sfy-sb-qty-button:hover {
      background-color: #f5f5f5;
    }
    
    .sfy-sb-qty-input {
      width: 40px;
      text-align: center;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 600;
      color: #141414;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: textfield;
    }
    
    .sfy-sb-qty-input::-webkit-outer-spin-button,
    .sfy-sb-qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .sfy-sb-qty-input[type=number] {
      -moz-appearance: textfield;
    }
    
    .sfy-sb-add-to-cart-button {
      border-radius: 8px;
      border: none;
      cursor: pointer;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      background: #141414;
      color: #fff;
      transition: background-color 0.2s;
    }
    
    .sfy-sb-add-to-cart-button:hover {
      background: #000;
    }
    
    .sfy-sb-add-to-cart-text {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .sfy-sb-add-to-cart-icon {
      display: flex;
      align-items: center;
    }
    
    .sfy-sb-add-to-cart-icon svg {
      width: 16px;
      height: 16px;
    }
    
    .sfy-svg {
      width: 16px;
      height: 16px;
    }
    
    @media (max-width: 768px) {
      .sfy-sb-container {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .sfy-sb-content {
        justify-content: space-between;
      }
      
      .sfy-sb-actions {
        flex-direction: row;
        justify-content: space-between;
      }
      
      .sfy-sb {
        padding: 12px;
      }
    }
  </style>
{% endif %}
{% schema %}
{
  "name": "Sticky Add to Cart Bar",
  "target": "section",
  "settings": [
    {
      "type": "color",
      "id": "bar_color",
      "label": "Bar background color",
      "default": "#f1f1f1"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}